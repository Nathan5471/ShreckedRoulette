<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>IP Address Roulette</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				max-width: 800px;
				margin: 0 auto;
				padding: 20px;
				background-color: #f5f5f5;
			}
			.container {
				background-color: white;
				border-radius: 8px;
				padding: 20px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			}
			.join-form {
				margin-bottom: 20px;
			}
			.game-area {
				display: none;
			}
			.user-list {
				border: 1px solid #ddd;
				padding: 10px;
				border-radius: 4px;
				margin-bottom: 20px;
				max-height: 200px;
				overflow-y: auto;
			}
			.user-item {
				padding: 5px;
				border-bottom: 1px solid #eee;
			}
			.user-item:last-child {
				border-bottom: none;
			}
			.events-log {
				border: 1px solid #ddd;
				padding: 10px;
				border-radius: 4px;
				height: 200px;
				overflow-y: auto;
				font-family: monospace;
				background-color: #f9f9f9;
			}
			.current-player {
				font-weight: bold;
				color: #ff5722;
			}
			.revealed {
				color: #d32f2f;
				font-weight: bold;
			}
			.safe {
				color: #388e3c;
				font-weight: bold;
			}
			button {
				background-color: #4caf50;
				color: white;
				border: none;
				padding: 10px 15px;
				border-radius: 4px;
				cursor: pointer;
			}
			button:hover {
				background-color: #45a049;
			}
			#clearPlayersButton {
				background-color: #f44336;
				margin-bottom: 15px;
			}
			#clearPlayersButton:hover {
				background-color: #d32f2f;
			}
			input {
				padding: 8px;
				border: 1px solid #ddd;
				border-radius: 4px;
				width: 250px;
			}
			.game-controls {
				margin: 15px 0;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h1>IP Address Roulette</h1>
			<p>Join the game and see who gets their IP address revealed!</p>

			<div class="join-form" id="joinForm">
				<h3>Enter your username to join:</h3>
				<input type="text" id="usernameInput" placeholder="Username" required />
				<button id="joinButton">Join Game</button>
			</div>

			<div class="game-area" id="gameArea">
				<h3>Players:</h3>
				<div class="user-list" id="userList"></div>

				<div id="gameStatus">
					<p>Waiting for more players to join (need at least 4)...</p>
				</div>

				<div class="game-controls">
					<button id="clearPlayersButton">Clear All Players</button>
				</div>

				<h3>Game Events:</h3>
				<div class="events-log" id="eventsLog"></div>
			</div>
		</div>

		<script>
			let socket;
			let myId = null;
			let username = '';
			let users = [];
			let gameInProgress = false;

			// DOM elements
			const joinForm = document.getElementById('joinForm');
			const gameArea = document.getElementById('gameArea');
			const usernameInput = document.getElementById('usernameInput');
			const joinButton = document.getElementById('joinButton');
			const userList = document.getElementById('userList');
			const gameStatus = document.getElementById('gameStatus');
			const eventsLog = document.getElementById('eventsLog');
			const clearPlayersButton = document.getElementById('clearPlayersButton');

			// Join button click handler
			joinButton.addEventListener('click', () => {
				username = usernameInput.value.trim();
				if (!username) {
					alert('Please enter a username');
					return;
				}

				connectWebSocket();
			});

			// Clear players button click handler
			clearPlayersButton.addEventListener('click', () => {
				if (confirm('Are you sure you want to clear all players?')) {
					socket.send(
						JSON.stringify({
							event: 'clearPlayers',
							data: {},
						})
					);
				}
			});

			function connectWebSocket() {
				// Get the current protocol (ws: or wss:)
				const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
				const wsUrl = `${protocol}//${window.location.host}/join`;

				socket = new WebSocket(wsUrl);

				socket.onopen = () => {
					logEvent('Connected to the game server');
					// Send join event with username
					socket.send(
						JSON.stringify({
							event: 'join',
							data: { username },
						})
					);
				};

				socket.onmessage = (event) => {
					const message = JSON.parse(event.data);
					handleWebSocketMessage(message);
				};

				socket.onerror = (error) => {
					logEvent('WebSocket error: ' + error.message, true);
				};

				socket.onclose = () => {
					logEvent('Disconnected from the game server', true);
				};
			}

			function handleWebSocketMessage(message) {
				const { event, data } = message;

				switch (event) {
					case 'joined':
						myId = data.id;
						users = data.users;
						showGameArea();
						updateUserList();
						logEvent(`You joined as ${username}`);
						break;

					case 'gameState':
						users = data.users;
						gameInProgress = data.gameInProgress;
						updateUserList();
						updateGameStatus(data);
						break;

					case 'userJoined':
						users.push({ id: data.id, username: data.username });
						updateUserList();
						logEvent(`${data.username} joined the game`);
						break;

					case 'userLeft':
						users = users.filter((user) => user.id !== data.id);
						updateUserList();
						logEvent(`${data.username} left the game`);
						break;

					case 'gameStarted':
						gameInProgress = true;
						logEvent('Game started!', false, 'current-player');
						updateGameStatus({ currentPlayer: data.currentPlayer });
						break;

					case 'playerTurn':
						logEvent(`It's ${data.playerUsername}'s turn...`);
						updateGameStatus({ currentPlayer: data.playerUsername });
						break;

					case 'ipRevealed':
						logEvent(`${data.playerUsername}'s IP address was revealed: ${data.playerIP}`, false, 'revealed');
						break;

					case 'ipSafe':
						logEvent(`${data.playerUsername}'s IP address remains hidden`, false, 'safe');
						break;

					case 'gameStopped':
						gameInProgress = false;
						logEvent(`Game stopped: ${data.reason}`, true);
						updateGameStatus({});
						break;

					case 'gameReset':
						users = [];
						gameInProgress = false;
						updateUserList();
						updateGameStatus({});
						logEvent(`Game reset: ${data.message}`, true);
						break;

					default:
						logEvent(`Unknown event: ${event}`);
				}
			}

			function updateUserList() {
				userList.innerHTML = '';
				users.forEach((user) => {
					const userItem = document.createElement('div');
					userItem.classList.add('user-item');
					userItem.textContent = user.username + (user.id === myId ? ' (You)' : '');
					userList.appendChild(userItem);
				});
			}

			function updateGameStatus(data) {
				if (gameInProgress) {
					if (data.currentPlayer) {
						gameStatus.innerHTML = `<p>Game in progress. Current player: <span class="current-player">${data.currentPlayer}</span></p>`;
					} else {
						gameStatus.innerHTML = '<p>Game in progress.</p>';
					}
				} else {
					const playersNeeded = Math.max(0, 4 - users.length);
					if (playersNeeded > 0) {
						gameStatus.innerHTML = `<p>Waiting for ${playersNeeded} more player${playersNeeded === 1 ? '' : 's'} to join...</p>`;
					} else {
						gameStatus.innerHTML = '<p>Enough players joined! Game will start soon...</p>';
					}
				}
			}

			function showGameArea() {
				joinForm.style.display = 'none';
				gameArea.style.display = 'block';
			}

			function logEvent(message, isError = false, className = '') {
				const logItem = document.createElement('div');
				if (isError) {
					logItem.style.color = 'red';
				}
				if (className) {
					logItem.classList.add(className);
				}
				logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
				eventsLog.appendChild(logItem);
				eventsLog.scrollTop = eventsLog.scrollHeight;
			}
		</script>
	</body>
</html>
